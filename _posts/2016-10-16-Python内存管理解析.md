---
layout: post
title:  "Pythonå†…å­˜ç®¡ç†åˆ†æ"
date:   2016-10-06
excerpt: "Pythonå†…å­˜ç®¡ç†åˆ†æ"
tag:
- Python
- å†…å­˜
- ç®¡ç†
comments: true
---

## 1. Pythonçš„å†…å­˜ç®¡ç†æ„æˆ

Pythonçš„å†…å­˜ç”±blockã€poolã€arenaç»„æˆã€‚

### 1.1 Block 
blockæœ‰å›ºå®šçš„sizeï¼Œæ˜¯æ¯æ¬¡è¯·æ±‚å†…å­˜çš„æ—¶å€™æ‹¿åˆ°çš„å…·ä½“å†…å­˜ï¼Œ8å­—èŠ‚å¯¹é½çš„ï¼Œæ‰€ä»¥æœ‰8ï¼Œ16ï¼Œ24ï¼Œ32 ã€‚ã€‚ã€‚ç­‰å¤§å°ã€‚å½“æŸæ¬¡éœ€è¦28ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šå¾—åˆ°ä¸€å—32å­—èŠ‚çš„blockã€‚
blockåœ¨Pythonçš„æºç ä¸­æ˜¯æ²¡æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„çš„ï¼Œå®ƒå…¶å®ä½“ç°æˆäº†Poolçš„ä¸€ä¸ªå±æ€§ã€‚

### 1.2 Pool
poolæ˜¯å›ºå®šsizeçš„blockçš„é›†åˆï¼Œä¸¾ä¸ªä¾‹å­è¦ä¹ˆæ˜¯32å­—èŠ‚blockçš„pool, è¦ä¹ˆæ˜¯64å­—èŠ‚blockçš„pool, ä»¥æ­¤ç±»æ¨ã€‚ poolçš„å¤§å°ä¹Ÿæ˜¯å›ºå®šçš„ï¼Œæ˜¯å†…å­˜é¡µçš„å¤§å°4KBã€‚
poolä¸»è¦ç”±pool_headerè¿™ä¸ªstructï¼Œä»¥åŠä»–æ‹¥æœ‰çš„å†…å­˜æ„æˆã€‚æ³¨æ„ï¼špool_headerå’Œä»–æ‹¥æœ‰çš„å†…å­˜æ˜¯ä¸€èµ·å­˜åœ¨çš„ï¼Œè¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿä¸€æ—¦ä¸€ä¸ªpoolè¢«newäº†å‡ºæ¥ï¼Œä¸ä»…ç«‹å³æ‹¥æœ‰äº†pool_headerï¼Œä¹Ÿç«‹å³æ‹¥æœ‰äº†poolç®¡ç†çš„å†…å­˜å—ã€‚è¿™æ˜¯ä¸åé¢arenaéå¸¸ä¸åŒçš„ä¸€ç‚¹ã€‚
æ¥ç®€å•çš„çœ‹ä¸€ä¸‹pool_headerè¿™ä¸ªstruct
{% highlight c %}
struct pool_header {
    union { block *_padding;
            uint count; } ref;      /* number of allocated blocks    */
    block *freeblock;               /* pool's free list head         */
    struct pool_header *nextpool;   /* next pool of this size class  */
    struct pool_header *prevpool;   /* previous pool       ""        */
    uint arenaindex;                /* index into arenas of base adr */
    uint szidx;                     /* block size class index        *
    uint nextoffset;                /* bytes to virgin block         */
    uint maxnextoffset;             /* largest valid nextoffset      */
 };
{% endhighlight %}
å¤§éƒ¨åˆ†ä»æ³¨é‡Šéƒ½å¯ä»¥çœ‹å‡ºæ¥å…·ä½“æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Œä¸Šæ–‡æˆ‘æåˆ°çš„block sizeå…¶å®ä½“ç°æˆäº†ä¸€ä¸ªpoolçš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯szidx, 0å°±æ˜¯8å­—èŠ‚ï¼Œ1å°±æ˜¯16å­—èŠ‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚freeblockæŒ‡å‘äº†ä¸‹ä¸€å—å¯ç”¨blockçš„èµ·å§‹åœ°å€ã€‚
æˆ‘ä¸ªäººè§‰å¾—Pythonåœ¨å¤„ç†freeblockè¿™ä¸ªåœ°æ–¹å†™æ³•éå¸¸trickã€‚ä¸€è€ƒè™‘åˆ°åˆ†é…å†…å­˜ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ°è¿™æ ·çš„åœºæ™¯ï¼šåˆ†é…äº†Nå—blockå†…å­˜åï¼Œæœ‰æŸå—æˆ–è€…æŸå‡ å—è¦è¢«é‡Šæ”¾äº†ï¼Œè¿™ä¸ªæ—¶å€™ä¸ºäº†é‡å¤åˆ©ç”¨è¿™äº›è¢«é‡Šæ”¾äº†çš„block, æˆ‘ä»¬é€šå¸¸ä¼šç»´æŠ¤ä¸€ä¸ªblockçš„åˆ—è¡¨ï¼ŒæŠŠè¿™äº›blockæ’å…¥åˆ°è¿™ä¸ªåˆ—è¡¨ä¸­ï¼Œé‚£ä¹ˆä¸‹æ¬¡åˆ†é…çš„æ—¶å€™ä¹Ÿå°±å¯ä»¥é¡ºåˆ©åˆ†é…ã€‚å…¶å®Pythonæºç ä¸­çš„freeblockå°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„ï¼Œä¸è¿‡å®ƒä»…ç”¨äº†ä¸€ä¸ªå®é™…ä¸Šuchar* çš„æŒ‡é’ˆå°±å®Œæˆäº†æ•´ä¸ªåˆ—è¡¨ï¼Œæˆ‘ä»¬æ¥çœ‹å®ƒæ˜¯æ€ä¹ˆåšçš„ã€‚

 1. freeblockåœ¨åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å‘äº†ä¸€å—å¯ç”¨çš„blockï¼Œ*freeblockå°±åº”è¯¥æ˜¯blockçš„å®é™…å†…å®¹ï¼Œè¢«åˆå§‹åŒ–æˆäº†NULL.
 2. å½“æœ‰ä¸€å—block Aè¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œ é¦–å…ˆè®©è¿™ä¸ªblockçš„é¦–å­—èŠ‚å˜ä¸ºfreeblockçš„åœ°å€ï¼Œï¼ˆåœ°å€å®é™…ä¸Šä¹Ÿå°±æ˜¯ä¸€ä¸ªæ•°å­—å˜›ï¼‰
 3. å†è®©freeblockæŒ‡å‘è¿™å—block Aã€‚
 

å½¢æˆäº†å¦‚ä¸‹çš„ç»“æ„ï¼š

![freeblock](http://pic.yupoo.com/fayewu_v/FUjejaqH/MKgSe.png)


----------


freelockæ˜¯block *, å…¶å®çœ‹ä»£ç å°±èƒ½å‘ç°æœ¬è´¨å°±æ˜¯uchar *ï¼ŒfreelockæŒ‡å‘çš„å†…å®¹æ˜¯ç¬¬ä¸€å—ç©ºé—²çš„blockï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå…·ä½“çš„å†…å­˜äº†ï¼Œè¿™å—å†…å­˜çš„å†…å®¹ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªåœ°å€ï¼Œä¸ºNULLã€‚ä¹Ÿå°±æ˜¯è¯´*freelock = = NULLï¼ˆæ²¡åŠæ³•ï¼Œä¸€åˆ‡éƒ½æ˜¯16è¿›åˆ¶ï¼Œç†è§£æˆåœ°å€ï¼å†…å®¹éƒ½æ˜¯å¯ä»¥çš„ã€‚ï¼‰
å½“ä¸€å—blockè¢«é‡Šæ”¾åï¼Œé¦–å…ˆè®©è¿™å—å†…å­˜çš„ç¬¬ä¸€å­—èŠ‚çš„å†…å®¹ï¼ˆä¹Ÿå¯ä»¥ç†è§£æˆåœ°å€ï¼‰å˜ä¸ºåŸæ¥ç¬¬ä¸€å—ç©ºé—²blockçš„åœ°å€ï¼Œç„¶åfreelockæŒ‡å‘è¿™å—å†…å­˜ã€‚æœ€ç»ˆå°±å˜ä¸º*freelockæŒ‡å‘äº†ä¸‹ä¸€å—blockçš„åœ°å€ã€‚
Pythonå°±è¿™æ ·ç”¨äº†ä¸€ä¸ªéå¸¸trickçš„æ–¹å¼ï¼Œä»…ä»…ç”¨freelockè¿™ä¸ªuchar *çš„æŒ‡é’ˆå®ç°äº†é“¾è¡¨ç»“æ„ã€‚

ä¸€ä¸ªpoolæœ‰ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼š

 1. used
    è¯´æ˜è¿™ä¸ªpoolä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªblockæ­£åœ¨è¢«å ç”¨ï¼Œè¿™ç§çŠ¶æ€çš„poolä¼šè¢«ä¸€ä¸ªå…¨å±€çš„usedpoolsç®¡ç†ï¼Œåé¢ä¼šè¯¦ç»†æåˆ°ã€‚

 2. empty
    è¿™ä¸ªpoolçš„å…¨éƒ¨blockéƒ½å¤„äºç©ºé—²çŠ¶æ€ã€‚pool_headerä¸­çš„next_poolè´Ÿè´£è¿æ¥è¿™äº›empty poolï¼Œè€Œarena_objectä¸­çš„freepoolsæ˜¯é“¾è¡¨å¤´ï¼Œè¿™æ ·æ¯ä¸ªarenaéƒ½æ‹¥æœ‰äº†è‡ªå·±çš„ä¸€æ¡empty poolsé“¾è¡¨ã€‚
 3. full

ä¸‹é¢æ¥è¯´ä¸€ä¸‹è¿™ä¸ªusedpoolsçš„å®ç°ï¼Œè¿™ä¸ªå®ç°å°±æ›´trickäº†ï¼Œå¥½é•¿æ—¶é—´ä¸å†™Cä»£ç äº†ï¼Œè¿˜è´¹äº†ç‚¹åŠ²æ‰ç†è§£ã€‚
æ¥çœ‹usedpoolsçš„å®šä¹‰(æˆ‘è¿™é‡Œåªæˆªå–äº†éƒ¨åˆ†ï¼Œ)ï¼š
{% highlight c %}
#define PTA(x)  ((poolp )((uchar *)&(usedpools[2*(x)]) - 2*size(block *)
#define PT(x)   PTA(x), PTA(x)
static poolp usedpools[2 * ((NB_SMALL_SIZE_CLASSES + 7) / 8) * 8] = {        
    PT(0), PT(1), PT(2), PT(3), PT(4), PT(5), PT(6), PT(7)
#if NB_SMALL_SIZE_CLASSES > 8
    , PT(8), PT(9), PT(10), PT(11), PT(12), PT(13), PT(14), PT(15)
......
}
{% endhighlight %}
poolpå³ä¸ºstruct pool_header *ã€‚usedpoolsæ˜¯ä¸€ä¸ªpool_header ï¼Šçš„é›†åˆï¼Œæ¯ä¸ªå…ƒç´ çš„å¤§å°ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚ï¼ˆæŒ‡é’ˆçš„å¤§å°ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ æŒ‡å‘çš„åœ°å€æ˜¯ä¸€ä¸ªpool_headerã€‚çœ‹ä¸€ä¸‹è¿™ä¸ªPTA(X), ä»¥PTX(1)ä¸ºğŸŒ°, block * çš„å¤§å°ä¸º8ä¸ªå­—èŠ‚ï¼Œ &usedpool[2 * 1] - 2 *sizeof(block *) è¿™ä¸ªåœ°å€å…¶å®ä»£è¡¨äº†usedpools[0]æœ¬èº«çš„åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´usedpool[2]å­˜æ”¾çš„æ˜¯å…¶å®æ˜¯usedpool[0]çš„åœ°å€ã€‚ä¸ºä»€ä¹ˆè¯´ä»–trickå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹struct pool_headerè¿™ä¸ªç»“æ„ï¼Œä¼šå‘ç°è¿™ä¸ªç»“æ„å¼€å¤´block ref, block *freepoolåˆ†åˆ«èŠ±äº†ä¸€ä¸ªå­—èŠ‚ï¼Œæ€»å…±ä¸¤ä¸ªå­—èŠ‚ã€‚æ¥ä¸‹æ¥å°±æ˜¯nextpoolæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´struct pool_headerçš„nextpoolçš„åœ°å€å…¶å®æ˜¯struct pool_headerèµ·å§‹åœ°å€åç§»ä¸¤ä¸ªå­—èŠ‚çš„ä½ç½®ã€‚
ç°åœ¨æˆ‘ä»¬èƒ½çœ‹å‡ºæ¥äº†ï¼Œusedpool[2]æŒ‡å‘äº†usedpool[0], è€Œusedpool[2]->nextpoolæ­£æ˜¯usedpool[0]ååç§»äº†ä¸¤ä¸ªå­—èŠ‚ï¼Œ ä¹Ÿå°±æ˜¯è¯´å¯¹äºiï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå®ƒçš„nextpoolæŒ‡å‘äº†å®ƒæœ¬èº«ã€‚ä¾æ¬¡ç±»æ¨ï¼ŒprepoolæŒ‡å‘äº†å’Œå®ƒXå€¼ä¸€æ ·çš„é‚£ä¸ªå…ƒç´ ã€‚ä¹Ÿå°±æ˜¯è¯´åªç”¨äº†ä¸¤ä¸ªæŒ‡é’ˆå°±å®ç°äº†ä¸€ä¸ªåŒé“¾è¡¨ã€‚ã€‚ã€‚

äºæ˜¯æœ‰äº†å¦‚ä¸‹éœ€è¦æŸä¸ªsizeå†…å­˜çš„blockçš„åˆ†é…ä»£ç ï¼š
{% highlight c %}
size = (uint)(nbytes - 1) >> ALIGNMENT_SHIFT;
pool = usedpools[size + size];
if (pool != pool->nextpool) {
    .....
}
{% endhighlight %}
å¦‚æœpoolä¸ç­‰äºpool->nextpool, è¯´æ˜ä¸æ˜¯åŒé“¾è¡¨ä¸ä¸ºç©ºã€‚æœ‰ç©ºé—²çš„blockå¯ä»¥è¢«åˆ†é…ã€‚
 
### 1.3 arena

arenaå°±æ˜¯poolçš„é›†åˆï¼Œä¹Ÿæœ‰å›ºå®šçš„å¤§å°: 256KB, ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªarenaå«æœ‰64ä¸ªpoolã€‚arenaåœ¨Pythonçš„æºç ä¸­æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œarena_objectå’Œå®ƒç®¡ç†çš„å†…å­˜ã€‚å‰é¢å…¶å®ä¹Ÿæœ‰æåˆ°ï¼Œå’Œpoolä¸åŒçš„æ˜¯ï¼Œarena_objectå’Œå®ƒç®¡ç†çš„å†…å­˜ä¸æ˜¯ä¸€èµ·è¢«åˆ†é…åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åˆ†é…äº†ä¸€ä¸ªæ–°çš„arenaçš„æ—¶å€™ï¼Œarena_objectè¢«åˆ†é…äº†ï¼Œè€Œå®ƒç®¡ç†çš„å†…å­˜è¿˜æ˜¯NULLã€‚è¿™ä¸ªæ—¶å€™çš„arenaè¢«æˆä¸ºâ€œæœªå¯ç”¨â€çŠ¶æ€ï¼Œè€Œå½“å®ƒç®¡ç†çš„å†…å­˜è¢«åˆ†é…äº†ï¼Œarenaå°±è¿›å…¥äº†â€œå¯ç”¨â€çŠ¶æ€ã€‚
ä¼—å¤šçš„arenaè¢«ä¸‰ä¸ªç»“æ„æ‰€ç®¡ç†ï¼š

 1. arenas
    arenasæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®é™…ä¸Šï¼Œä»Pythonçš„å…¨å±€å†…å­˜ç®¡ç†æ¥çœ‹ï¼Œarenasç»„æˆäº†å†…å­˜ç®¡ç†çš„ä¸»ä½“ç»“æ„éƒ¨åˆ†ã€‚æ‰€æœ‰çš„arenaéƒ½é€ƒä¸è¿‡arenasçš„æŒæ§ã€‚

 2. unused_arena_objects
    ä¸Šè¿°ä¸­â€œæœªå¯ç”¨â€çŠ¶æ€çš„arenaé›†åˆï¼Œæ–°ç”³è¯·å¥½çš„arena_objectéƒ½ä¼šå…ˆè¿›å…¥è¿™ä¸ªé›†åˆä¸­ã€‚
 3. used_arena_objects
    ä¸Šè¿°ä¸­â€œå¯ç”¨â€çŠ¶æ€çš„arenaé›†åˆã€‚

æ¥çœ‹ä¸€ä¸‹arena_objectçš„ä»£ç ç»“æ„ï¼š
{% highlight c %}
/* Record keeping for arenas. */
struct arena_object {
    uptr address;
    /* Pool-aligned pointer to the next pool to be carved off. */
    block* pool_address;
    
    /* The number of available pools in the arena:  free pools + never-
    * allocated pools.
    */
    uint nfreepools;
    struct pool_header* freepools;
    struct arena_object* nextarena;
    struct arena_object* prevarena;
};
{% endhighlight %}
æ³¨æ„unused_arena_objects, used_arena_objectsä¸­çš„arenaæ­£æ˜¯é€šè¿‡æœ€åè¿™ä¸¤ä¸ªarenaæŒ‡é’ˆè¿›è¡Œè¿æ¥çš„ã€‚

##2. Pythonçš„å†…å­˜ç®¡ç†å›¾

æœ‰äº†section 1çš„ä»‹ç»ï¼Œæ˜¯æ—¶å€™ç¥­å‡ºæ¥Pythonå†…å­˜ç®¡ç†è¿™å¼ å¤§å›¾äº†
![å†…å­˜ç®¡ç†å›¾] (http://pic.yupoo.com/fayewu_v/FVGPgZe9/lOwtP.png)


##3. ä¸€å¼ å›¾çœ‹æ‡‚PyObject_Mallocåšäº†ä»€ä¹ˆ

![å†…å­˜åˆ†é…](http://pic.yupoo.com/fayewu_v/FVGDWcqE/1M1HG.png)


 
